<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title></title>
    <script src="js/knockout-3.5.1.js" type="text/javascript"></script>
    <script src="js/rlab.ext.js" type="text/javascript"></script>
    <script src="js/chart.min.js" type="text/javascript"></script>
    <script src="js/knockout.chart.js" type="text/javascript"></script>

</head>
<body>
    <table>
        <tr>
            <td>
                <a>date selection range</a>
                <button data-bind="click: GetData">GetData</button>
                <input type="text" maxlength="30" data-bind="textInput: dateBegin " />
                <input type="text" maxlength="30" data-bind="textInput: dateEnd " />
                
                <a>averaging algorithm</a>
                <select data-bind="options: Algorithms, value: selectedAlgorithm"></select>
            </td>
        </tr>
        <tr>
            <td>
                <pre data-bind="text: Outcome"></pre>
            </td>
        </tr>
    </table>
    <div id="GraphCanvas">
        <canvas class="" data-bind="chart: { type: 'line', data: ChartData, options: ChartOptions }"></canvas>
    </div>
    <table>
        <thead>
            <tr>
                <th>date</th>
                <th>temperature</th>
                <th>Wind Direction</th>
            </tr>
        </thead>
        <tbody data-bind="foreach: DataArray">
            <tr>
                <td style="text-align: center; width:280px;" data-bind="text: Date"></td>
                <td style="text-align: right; width:60px;" data-bind="text: Temp"></td>
                <td style="text-align: right; width:60px;" data-bind="text: WindDir"></td>
            </tr>
        </tbody>
    </table>
    <script>

        var ClickCounterViewModel = function () {

            this.RequestHeaders = {
                "Content-Type": "application/json",
                "Accept": "application/json",
            };

            this.ChartOptions = {
                responsive: true,
                animation: false,
                observeChanges: true,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                elements: {
                    line: { borderWidth: 1 },
                    point: { radius: 0 }
                },
                parsing: { xAxisKey: 'Date' },
                plugins: { legend: { display: false } },
            };

            this.ChartData = ko.pureComputed(() => {
                let items = this.DataArray().slice().sort((a, b) => (a.Date - b.Date));
                //console.log(JSON.stringify(items));
                return {
                    labels: items.map(i => i.Date.format("HH-MM-ss")),
                    //labels: items.map(i => i.Date),
                    datasets: [
                        { label: 'Temp', data: items, parsing: { yAxisKey: 'Temp' }, borderColor: 'green' },
                        //{ label: 'WindDir', data: items, parsing: { yAxisKey: 'WindDir' }, borderColor: 'blue' },
                    ]
                };
            });

            this.Algorithms = ko.observableArray([]);
            this.selectedAlgorithm = ko.observable("");


            this.dateBegin = ko.observable("2022-01-03T12:00:00Z");
            this.dateEnd = ko.observable("2022-01-03T14:00:00Z");
            this.Outcome = ko.observable(0);//отладочные данные
            this.DataArray = ko.observableArray([]);

            //var canvasScale = document.getElementById("GraphCanvas").clientWidth;

            this.GetData = function () {
                fetch("http://localhost:50343/Service2.svc/dan?" +
                    "dateBegin=" + this.dateBegin() +
                    "&dateEnd=" + this.dateEnd() +
                    "&algorithm=" + this.selectedAlgorithm() +
                    "&scale=" + document.getElementById("GraphCanvas").clientWidth,
                    { headers: this.RequestHeaders })
                    .then(response => response.json())
                    .then(data => {
                        data.forEach(i => {
                            i.Date = new Date(i.Date);
                        });

                        this.DataArray(data);
                    })
            };

            //receive Algorithms
            this.GetAlgorithms = function () {
                fetch("http://localhost:50343/Service2.svc/algorithms",
                    { headers: this.RequestHeaders })
                    .then(response => response.json())
                    .then(data => this.Algorithms(["", ...data]));
            };
        };

        var model = new ClickCounterViewModel();
        model.GetAlgorithms();
        ko.applyBindings(model);
    </script>
</body>
</html>